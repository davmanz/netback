# Netback Proxy ‚Äî ENDPOINTS\n\nEl **Proxy** (FastAPI) act√∫a como **BFF**: valida/propaga autenticaci√≥n y reexpone los endpoints del Backend Django casi **1:1**.\n\n- **V√≠a Nginx (Frontend / navegador):** se llama con prefijo `/api/...` y Nginx lo reescribe al proxy.\n- **Directo al Proxy:** las rutas **no** llevan `/api/` (ej.: `http://localhost:8080/auth/login/`).\n\n> **Cabeceras**: donde se requiere autenticaci√≥n, usar `Authorization: Bearer &lt;ACCESS_TOKEN&gt;`.\n\n---\n\n## üîê Autenticaci√≥n (delegada al Backend)\n### POST `/auth/login/`\nAutentica usuario y devuelve el par de tokens **JWT** (`access`, `refresh`). Internamente delega al Backend (`POST /api/token/`).\n\n**Request**\n```json\n{ \"username\": \"admin\", \"password\": \"&lt;clave&gt;\" }\n```\n**200 OK**\n```json\n{ \"access\": \"...\", \"refresh\": \"...\" }\n```\n\n**cURL (directo al proxy)**\n```bash\nPROXY=http://localhost:8080\ncurl -X POST \"$PROXY/auth/login/\" \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"username\":\"admin\",\"password\":\"adminpassword\"}'\n```\n\n**cURL (v√≠a Nginx desde el Frontend)**\n```bash\nFRONT=http://localhost:80\ncurl -X POST \"$FRONT/api/auth/login/\" \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"username\":\"admin\",\"password\":\"adminpassword\"}'\n```\n\n> Usa el token `access` en el resto de endpoints: `-H \"Authorization: Bearer $ACCESS\"`.\n\n---\n\n## üè• Salud del Proxy\n### GET `/health/`\nEndpoint simple de salud del Proxy (usado por el **healthcheck** del contenedor). Responde 200 si el proceso est√° arriba.\n\n**cURL**\n```bash\ncurl http://localhost:8080/health/\n```\n\n---\n\n## üë§ Usuarios (passthrough)\n**Rutas Proxy** ‚Üí mapean a Backend `/api/users/`.\n\n| Acci√≥n | M√©todo/Path (Proxy) | Auth |\n|---|---|---|\n| Listar | GET `/users/` | Bearer |\n| Crear | POST `/users/` | **admin** |\n| Ver | GET `/users/{uuid}/` | Bearer |\n| Actualizar | PUT/PATCH `/users/{uuid}/` | **admin** (o autenticado seg√∫n l√≥gica) |\n| Borrar | DELETE `/users/{uuid}/` | **admin** |\n| Yo | GET `/users/me/` | Bearer |\n\n**Ejemplo (listar)**\n```bash\ncurl \"$FRONT/api/users/\" -H \"Authorization: Bearer $ACCESS\"\n```\n\n---\n\n## üåç Ubicaciones (pa√≠ses, sitios, √°reas) (passthrough)\n**Rutas Proxy** ‚Üí Backend `/api/countries/`, `/api/sites/`, `/api/areas/`.\n\n- Pa√≠ses: `GET/POST/PUT/PATCH/DELETE /countries/` (Bearer)\n- Sitios: `GET/POST/PUT/PATCH/DELETE /sites/` (Bearer) ‚Äî filtro `?country_id=&lt;uuid&gt;`\n- √Åreas: `GET/POST/PUT/PATCH/DELETE /areas/` (Bearer) ‚Äî filtros `?site_id=` **o** `?country_id=`\n\n**Ejemplo (√°reas por pa√≠s)**\n```bash\ncurl \"$FRONT/api/areas/?country_id=&lt;UUID&gt;\" -H \"Authorization: Bearer $ACCESS\"\n```\n\n---\n\n## üõ†Ô∏è Cat√°logos (passthrough)\n- Fabricantes: `/manufacturers/` (Bearer)\n- Tipos de equipo: `/devicetypes/` (Bearer)\n\n**Ejemplo**\n```bash\ncurl \"$FRONT/api/manufacturers/\" -H \"Authorization: Bearer $ACCESS\"\n```\n\n---\n\n## üîå Dispositivos de Red (passthrough)\n**Rutas Proxy** ‚Üí Backend `/api/networkdevice/`.\n\n| Acci√≥n | M√©todo/Path | Rol |\n|---|---|---|\n| Listar | GET `/networkdevice/` | viewer+ |\n| Crear | POST `/networkdevice/` | operator+ |\n| Ver/Editar/Borrar | `/{uuid}/` | ver: viewer+ / editar/borrar: admin |\n\n**Ejemplo (crear)**\n```bash\ncurl -X POST \"$FRONT/api/networkdevice/\" \\\n  -H \"Authorization: Bearer $ACCESS\" -H 'Content-Type: application/json' \\\n  -d '{\n    \"hostname\":\"sw-core-1\",\n    \"ipAddress\":\"192.168.1.10\",\n    \"model\":\"Cisco IOS\",\n    \"manufacturer\":\"&lt;uuid&gt;\",\n    \"deviceType\":\"&lt;uuid&gt;\",\n    \"area\":\"&lt;uuid&gt;\",\n    \"vaultCredential\":\"&lt;uuid&gt;\"\n  }'\n```\n\n> **Regla**: no mezclar `vaultCredential` con `customUser/customPass`.\n\n---\n\n## üîë Credenciales (Vault) (passthrough)\n**Rutas Proxy** ‚Üí Backend `/api/vaultcredentials/` (operator+)\n\n**Ejemplo**\n```bash\ncurl -X POST \"$FRONT/api/vaultcredentials/\" \\\n  -H \"Authorization: Bearer $ACCESS\" -H 'Content-Type: application/json' \\\n  -d '{\"nick\":\"ops-cisco\",\"username\":\"netops\",\"password\":\"s3cr3t\"}'\n```\n\n---\n\n## üíæ Backups (passthrough)\n**Rutas Proxy** ‚Üí Backend `/api/backup/` y acciones auxiliares.\n\n- CRUD de Backups: `/backup/` (viewer+/operator+/admin seg√∫n acci√≥n)\n- Forzar backup: **POST** `/networkdevice/{uuid}/backup/`\n- Historial por equipo: **GET** `/networkdevice/{uuid}/backups/`\n- Estados por equipo: **GET** `/networkdevice/{uuid}/status/`\n- √öltimos por equipo: **GET** `/backups/last/`\n\n**Ejemplo (forzar backup)**\n```bash\ncurl -X POST \"$FRONT/api/networkdevice/$DEVICE_ID/backup/\" \\\n  -H \"Authorization: Bearer $ACCESS\"\n```\n\n---\n\n## üîç Comparaciones (passthrough)\n- Dos √∫ltimos: **GET** `/networkdevice/{uuid}/compare/`\n- Espec√≠ficos: **GET** `/backups/compare/{backupOldId}/{backupNewId}/`\n\n**Ejemplo**\n```bash\ncurl \"$FRONT/api/networkdevice/$DEVICE_ID/compare/\" -H \"Authorization: Bearer $ACCESS\"\n```\n\n---\n\n## üì° Comandos & Diagn√≥stico (passthrough)\n- Ejecutar comando: **POST** `/networkdevice/{uuid}/command/`  `{ \"command\": \"show running-config\" }`\n- Ping: **POST** `/ping/`  `{ \"ip\": \"8.8.8.8\" }`\n\n**Ejemplo (ping)**\n```bash\ncurl -X POST \"$FRONT/api/ping/\" -H \"Authorization: Bearer $ACCESS\" \\\n  -H 'Content-Type: application/json' -d '{\"ip\":\"8.8.8.8\"}'\n```\n\n---\n\n## üîÅ Programaci√≥n de Backups (passthrough)\n- **POST** `/backup-config/schedule/` ‚Äî admin (body: `{ \"scheduled_time\": \"01:00\" }`)\n- **GET** `/backup-config/schedule/get/` ‚Äî admin\n\n---\n\n## üß† Clasificaci√≥n (Zabbix/CSV) (passthrough)\n- **POST** `/networkdevice/bulk/from-zabbix/` ‚Äî admin `{ \"ruleSetId\": \"&lt;uuid&gt;\" }`\n- **POST** `/networkdevice/bulk/from-csv/` ‚Äî admin (`multipart/form-data`: `file`, `ruleSetId`)\n- **POST** `/networkdevice/bulk/save/` ‚Äî Bearer (guardar clasificados)\n- **GET** `/zabbix/status/` ‚Äî admin\n\n---\n\n## üìé Notas\n- El Proxy centraliza CORS y autenticaci√≥n: si `Authorization` falta o el token expira, responde **401**.\n- Para operaciones **admin**, el Proxy valida rol (403 si no cumple).\n- En general, los **paths** y **m√©todos** replican al Backend; usar `/api/...` desde el Frontend/Nginx.\n\nPara detalles finos de payloads y respuestas, ver **Backend ‚Äî ENDPOINTS.md**.\n