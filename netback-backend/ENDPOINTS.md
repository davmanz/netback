# Netback Backend — ENDPOINTS\n\nAPI base: `http://&lt;host&gt;:8000/api/`\n\n> **Auth:** Todas las rutas (salvo `/api/health/` y el propio `/api/token/`) requieren cabecera\n> `Authorization: Bearer &lt;ACCESS_TOKEN&gt;`.\n>\n> **Roles:** `admin`, `operator`, `viewer`. Si no se indica, basta con usuario autenticado.\n\n---\n\n## 🔐 Autenticación (JWT)\n\n### 1) Obtener token\n**POST** `/api/token/`\n```json\n{\n  \"username\": \"admin\",\n  \"password\": \"&lt;clave&gt;\"\n}\n```\n**200 OK**\n```json\n{ \"access\": \"...\", \"refresh\": \"...\" }\n```\n**cURL**\n```bash\ncurl -X POST \"$API/token/\" \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"username\":\"admin\",\"password\":\"adminpassword\"}'\n```\n\n### 2) Refresh token\n**POST** `/api/token/refresh/`\n```json\n{ \"refresh\": \"...\" }\n```\n**200 OK** → `{ \"access\": \"...\" }`\n\n---\n\n## 👤 Usuarios\nRecurso: `/api/users/` (ModelViewSet)\n\n| Acción | Método/Path | Permiso |\n|---|---|---|\n| Listar | GET `/api/users/` | **Autenticado** |\n| Crear | POST `/api/users/` | **admin** |\n| Ver detalle | GET `/api/users/{id}/` | **Autenticado** |\n| Actualizar | PUT/PATCH `/api/users/{id}/` | **admin** (o autenticado según lógica interna) |\n| Borrar | DELETE `/api/users/{id}/` | **admin** |\n| Yo | GET `/api/users/me/` | **Autenticado** |\n\n**Ejemplo crear usuario (admin)**\n```bash\ncurl -X POST \"$API/users/\" -H \"Authorization: Bearer $ACCESS\" \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"username\":\"op1\",\"email\":\"op1@demo.com\",\"password\":\"secret\",\"role\":\"operator\"}'\n```\n\n---\n\n## 🌍 Ubicación\n### Países `/api/countries/`  (autenticado)\nCRUD completo.\n\n### Sitios `/api/sites/`  (autenticado)\n- Filtro: `?country_id=&lt;uuid&gt;`\n\n### Áreas `/api/areas/`  (autenticado)\n- Filtros: `?site_id=&lt;uuid&gt;` **o** `?country_id=&lt;uuid&gt;`\n\n**Ejemplo listar áreas por país**\n```bash\ncurl \"$API/areas/?country_id=&lt;UUID&gt;\" -H \"Authorization: Bearer $ACCESS\"\n```\n\n---\n\n## 🛠️ Catálogos\n### Fabricantes `/api/manufacturers/` (autenticado)\nCampos clave: `name`, `get_running_config`, `get_vlan_info`, `netmiko_type`.\n\n### Tipos de equipo `/api/devicetypes/` (autenticado)\n\n---\n\n## 🔌 Dispositivos de red\nRecurso: `/api/networkdevice/` (ModelViewSet)\n\n| Acción | Método/Path | Permiso |\n|---|---|---|\n| Listar | GET `/api/networkdevice/` | **viewer+** |\n| Crear | POST `/api/networkdevice/` | **operator+** |\n| Ver detalle | GET `/api/networkdevice/{uuid}/` | **viewer+** |\n| Actualizar | PUT/PATCH `/api/networkdevice/{uuid}/` | **admin** |\n| Borrar | DELETE `/api/networkdevice/{uuid}/` | **admin** |\n\n**Body crear** (IDs por FK)\n```json\n{\n  \"hostname\": \"sw-core-1\",\n  \"ipAddress\": \"192.168.1.10\",\n  \"model\": \"Cisco IOS\",\n  \"manufacturer\": \"&lt;uuid manufacturer&gt;\",\n  \"deviceType\": \"&lt;uuid devicetype&gt;\",\n  \"area\": \"&lt;uuid area&gt;\",\n  \"vaultCredential\": \"&lt;uuid vault&gt;\"\n}\n```\n> **Regla:** No se puede usar `vaultCredential` **y** `customUser/customPass` al mismo tiempo.\n\n---\n\n## 🔑 Credenciales (Vault)\nRecurso: `/api/vaultcredentials/` — **operator+**\n- Crea/gestiona credenciales cifradas con **Fernet** (campo `password` se cifra al guardar).\n\n**Ejemplo crear**\n```bash\ncurl -X POST \"$API/vaultcredentials/\" -H \"Authorization: Bearer $ACCESS\" \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"nick\":\"ops-cisco\",\"username\":\"netops\",\"password\":\"s3cr3t\"}'\n```\n\n---\n\n## 💾 Backups\nRecurso: `/api/backup/` (ModelViewSet)\n\n| Acción | Método/Path | Permiso |\n|---|---|---|\n| Listar/Ver | GET `/api/backup/` | **viewer+** |\n| Crear | POST `/api/backup/` | **operator+** |\n| Actualizar/Borrar | PUT/PATCH/DELETE | **admin** |\n\n### Acciones por dispositivo\n- **Forzar backup** — **POST** `/api/networkdevice/{uuid}/backup/` (operator+)\n  - **200** `{ \"success\": true, \"backupId\": \"uuid\", \"parsed_vlan\": {...} }`\n- **Historial** — **GET** `/api/networkdevice/{uuid}/backups/` (viewer+)\n  - **200** `[ {\"id\":\"uuid\",\"backupTime\":\"...\"}, ... ]`\n- **Estados** — **GET** `/api/networkdevice/{uuid}/status/` (autenticado)\n  - **200** `{ \"device\":\"sw-core-1\", \"statuses\":[{\"status\":\"completed\",\"message\":\"...\",\"backupTime\":\"...\"}] }`\n\n### Últimos backups por dispositivo\n**GET** `/api/backups/last/` (autenticado)\n```json\n[\n  {\n    \"id\": \"&lt;device uuid&gt;\",\n    \"hostname\": \"sw-core-1\",\n    \"ipAddress\": \"192.168.1.10\",\n    \"lastBackup\": \"2025-02-18T00:00:00Z\",\n    \"backup_id\": \"&lt;backup uuid&gt;\"\n  }\n]\n```\n\n---\n\n## 🔍 Comparaciones de respaldos\n- **Comparar 2 últimos** — **GET** `/api/networkdevice/{uuid}/compare/` (autenticado)\n- **Comparar por IDs** — **GET** `/api/backups/compare/{backupOldId}/{backupNewId}/` (autenticado)\n\n**Respuesta (200)**\n```json\n{\n  \"success\": true,\n  \"backupDiffId\": \"uuid\",\n  \"changes\": {\n    \"added\": [{\"interface Gig1/0/1\": [\"++ switchport access vlan 20\"]}],\n    \"removed\": [{\"interface Gig1/0/2\": [\"-- description old\"]}],\n    \"modified\": [{\"line vty 0 4\": [\"-- login local\",\"++ transport input ssh\"]}],\n    \"vlanInfo\": {\"vlans\": {\"20\": \"Users\"}, \"ports_vlan\": {\"20\": {\"assigned\": [\"Gi1/0/10\"], \"removed\": []}}}\n  }\n}\n```\n\n**cURL**\n```bash\ncurl \"$API/networkdevice/$DEVICE_ID/compare/\" -H \"Authorization: Bearer $ACCESS\"\n```\n\n### BackupDiff (histórico de difs)\nRecurso: `/api/backupdiff/` — **autenticado** (listar/ver).\n\n---\n\n## 📡 Comandos & Diagnóstico\n- **Ejecutar comando** — **POST** `/api/networkdevice/{uuid}/command/` (autenticado)\n  - Body: `{ \"command\": \"show running-config\" }`\n  - Respuesta: `{ \"result\": \"...salida...\" }`\n\n- **Ping** — **POST** `/api/ping/` (autenticado)\n  - Body: `{ \"ip\": \"8.8.8.8\" }`\n  - 200 success → `{ \"status\":\"success\", \"data\": {\"reachable\":true, \"stats\": {\"transmitted\":2,\"received\":2,\"loss_percentage\":0} } }`\n\n---\n\n## 🔁 Programación de backups\n- **Configurar hora** — **POST** `/api/backup-config/schedule/` — **admin**\n  - Body: `{ \"scheduled_time\": \"01:00\" }` (HH:MM 24h)\n  - 200 → `{ \"success\": true, \"message\": \"Respaldo programado a las 01:00\", \"schedule_id\": \"uuid\" }`\n\n- **Obtener hora** — **GET** `/api/backup-config/schedule/get/` — **admin**\n  - 200 → `{ \"scheduled_time\": \"01:00\" }` (o 404 si no existe)\n\n> La tarea periódica `core.tasks.autoBackup` corre cada minuto y ejecuta backups **solo** cuando la hora actual coincide con `BackupSchedule.scheduled_time`.\n\n---\n\n## 🧠 Clasificación (Zabbix/CSV)\n- **Desde Zabbix** — **POST** `/api/networkdevice/bulk/from-zabbix/` — **admin**\n  - Body: `{ \"ruleSetId\": \"&lt;uuid rule set&gt;\" }`\n  - 200 → lista de hosts clasificados, cada uno con `manufacturer`, `deviceType`, `area` (resuelta) y campos detectados.\n\n- **Desde CSV** — **POST** `/api/networkdevice/bulk/from-csv/` — **admin**\n  - Form-Data: `file=@hosts.csv`, `ruleSetId=...`\n\n- **Guardar clasificados** — **POST** `/api/networkdevice/bulk/save/` — **autenticado**\n  - Body: `{ \"hosts\": [ {\"hostname\":\"...\",\"ipAddress\":\"...\",\"model\":\"...\",\"manufacturer\":\"&lt;uuid&gt;\",\"deviceType\":\"&lt;uuid&gt;\",\"area\":\"&lt;uuid&gt;\",\"vaultCredential\":\"&lt;uuid|null&gt;\"}, ... ] }`\n  - 201/400 con `{ \"created\": N, \"errors\": [ {\"hostname\":\"...\",\"error\":\"...\"} ] }`\n\n- **Estado conectividad Zabbix** — **GET** `/api/zabbix/status/` — **admin**\n  - 200 → `{ \"activate\": true|false, \"zabbix_api_status\": \"ok|error|skipped\", \"connect_attempted\": bool, \"ping\": {\"drop\": X, \"pass\": Y} }`\n\n---\n\n## 🏥 Salud\n- **GET** `/api/health/` — **público**\n  - 200 → `{ \"status\": \"ok\", \"message\":\"Backend is up and running!\", \"timestamp\": \"...\" }`\n\n---\n\n## 📝 Notas de seguridad\n- Preferir `vaultCredential` a `customPass`. Si se usa `customPass`, considerar cifrar.\n- Roles: **admin** para operaciones peligrosas (borrado/actualización global, programación, Zabbix).\n- Definir `ENCRYPTION_KEY_VAULT` y `SECRET_KEY` por entorno.\n