# Netback â€” Backend (Django REST API)\n\nAPI REST para **gestiÃ³n de dispositivos de red y respaldos**. Incluye autenticaciÃ³n **JWT**, ejecuciÃ³n de comandos vÃ­a **Netmiko**, tareas en segundo plano con **Celery**/**Redis** y persistencia en **PostgreSQL**.\n\n---\n\n## ğŸ§­ Â¿QuÃ© hace?\n- **Usuarios y roles**: _admin_, _operator_, _viewer_.\n- **Inventario**: fabricantes, tipos de dispositivo, paÃ­ses, sitios, Ã¡reas y dispositivos.\n- **Respaldos**: obtenciÃ³n de `running-config` y `vlan brief`, deduplicaciÃ³n por _checksum_, historial y **comparaciÃ³n estructurada** entre respaldos.\n- **AutomatizaciÃ³n**: _scheduler_ diario/con hora configurable con **Celery**.\n- **DiagnÃ³stico**: ejecuciÃ³n de comandos y **ping** desde el servidor.\n- **IntegraciÃ³n Zabbix**: clasificaciÃ³n/ingesta de hosts por reglas.\n\n---\n\n## ğŸ—ï¸ Stack & Dependencias\n- **Python 3.13**, **Django 5**, **Django REST Framework**\n- **JWT (SimpleJWT)**\n- **PostgreSQL** (psycopg2-binary)\n- **Celery 5** + **Redis** (django-celery-beat / django-celery-results)\n- **Netmiko** (con `ntc_templates`)\n- **cryptography.Fernet** para cifrar credenciales en _VaultCredential_\n\n> Ver `requirements.txt` para el detalle de librerÃ­as.\n\n---\n\n## ğŸ”Œ Endpoints principales\nRuta base: `/api/`\n\n- **Auth**\n  - `POST /api/token/` â€” obtener `access` y `refresh`\n  - `POST /api/token/refresh/` â€” renovar `access`\n  - `GET  /api/users/me/` â€” perfil del usuario autenticado\n\n- **Usuarios** (`/api/users/` â€” _admin_ requerido para crear/eliminar)\n\n- **UbicaciÃ³n**\n  - `countries`, `sites`, `areas` â€” filtros por `?country_id=` / `?site_id=`\n\n- **Dispositivos** (`/api/networkdevice/`)\n  - `GET` (_viewer_+), `POST` (_operator_+), `PUT/PATCH/DELETE` (_admin_)\n  - Acciones:\n    - `POST /api/networkdevice/{uuid}/command/` â€” ejecutar comando Netmiko\n    - `POST /api/networkdevice/{uuid}/backup/` â€” forzar respaldo\n    - `GET  /api/networkdevice/{uuid}/backups/` â€” historial\n    - `GET  /api/networkdevice/{uuid}/compare/` â€” comparar 2 Ãºltimos\n    - `GET  /api/backups/compare/{old}/{new}/` â€” comparar por IDs\n\n- **Backups**\n  - `GET  /api/backups/last/` â€” Ãºltimo backup por dispositivo\n\n- **Estado y salud**\n  - `GET  /api/networkdevice/{uuid}/status/` â€” estados de backup\n  - `GET  /api/health/` â€” _healthcheck_ del backend (pÃºblico)\n\n- **Zabbix & ClasificaciÃ³n** (solo _admin_)\n  - `POST /api/networkdevice/bulk/from-zabbix/` â€” clasificar hosts desde Zabbix\n  - `POST /api/networkdevice/bulk/from-csv/` â€” clasificar desde CSV\n  - `POST /api/networkdevice/bulk/save/` â€” persistir clasificados\n  - `GET  /api/zabbix/status/` â€” ping + conectividad a API Zabbix\n\n- **ProgramaciÃ³n de backups** (solo _admin_)\n  - `POST /api/backup-config/schedule/` â€” setear hora `HH:MM`\n  - `GET  /api/backup-config/schedule/get/` â€” obtener hora vigente\n\n---\n\n## ğŸ—ƒï¸ Modelos clave\n- `UserSystem` (usuario, `role`)\n- `VaultCredential` (usuario/clave cifrados con **Fernet**)\n- `Manufacturer` (comandos y `netmiko_type`)\n- `DeviceType`, `Country`, `Site`, `Area`\n- `NetworkDevice` (hostname, IP, fabricante, tipo, credencial)\n- `Backup` (runningConfig, vlanBrief, checksum)\n- `BackupDiff` (dif estructurado por secciones y VLAN)\n- `BackupStatus` (eventos in_progress/completed/failed)\n- `BackupSchedule` (hora programada)\n- `BackupStatusTracker` (`success|unchanged|error`, contadores)\n\n---\n\n## ğŸ§° Tareas y Scheduler (Celery)\n- Tarea periÃ³dica: `core.tasks.autoBackup` â€” ejecuta respaldos cuando la hora actual coincide con `BackupSchedule`.\n- _Beat_: puedes usar **DatabaseScheduler** (via `django_celery_beat`) o el `beat_schedule` definido en `backend/celery.py` (si no usas DatabaseScheduler).\n\n> Si usas DatabaseScheduler, crea una **PeriodicTask** por admin/command para llamar `core.tasks.autoBackup` cada minuto.\n\n---\n\n## âš™ï¸ Variables de entorno (ejemplo)\n```\n# Django / Seguridad\nSECRET_KEY=...\nTIME_ZONE=America/Santiago\nALLOWED_HOSTS=netback-backend,localhost\n\n# Base de datos\nPOSTGRES_DB=netback\nPOSTGRES_USER=netback\nPOSTGRES_PASSWORD=netback\nPOSTGRES_HOST=postgres\nPOSTGRES_PORT=5432\n\n# Celery / Redis\nCELERY_BROKER_URL=redis://redis:6379/0\n\n# Zabbix\nZABBIX_URL=https://zabbix.example.com\nZABBIX_TOKEN=xxxxx\n\n# Cifrado credenciales VaultCredential\nENCRYPTION_KEY_VAULT=&lt;clave_fernet_base64&gt;\n\n# CORS (si aplica)\nCORS_ALLOWED_ORIGINS=http://localhost\n```\n\n---\n\n## â–¶ï¸ CÃ³mo ejecutar\n### Docker Compose (recomendado)\n1) Crear archivo `.env` en `netback-env/` (ver ejemplo arriba).\n2) Levantar servicios desde la raÃ­z del repo:\n```bash\ndocker compose up -d --build\n```\nServicios: `postgres`, `redis`, `backend`, `celery`, `celery-beat`, `proxy`, `frontend`.\n\n### Local (desarrollo)\n```bash\npython -m venv .venv && source .venv/bin/activate\npip install -r requirements.txt\nexport $(cat ../netback-env/.env | xargs)\npython manage.py migrate\npython manage.py runserver 0.0.0.0:8000\n# Celery\ncelery -A backend worker --loglevel=info\ncelery -A backend beat --loglevel=info  # si usas beat en cÃ³digo, omite DatabaseScheduler\n```\n\n---\n\n## ğŸ” Healthchecks / DiagnÃ³stico\n- Backend: `GET /api/health/`\n- Ping dispositivo: `POST /api/ping/` body: `{ \"ip\": \"8.8.8.8\" }`\n- Ãšltimos backups: `GET /api/backups/last/`\n- Comparaciones: `GET /api/networkdevice/{uuid}/compare/`\n\n---\n\n## ğŸ” Permisos & Seguridad\n- **Roles**:\n  - _admin_: CRUD completo, configura horarios y Zabbix.\n  - _operator_: crear dispositivos y ejecutar backups manuales.\n  - _viewer_: solo lectura.\n- **JWT** obligatorio salvo `/api/health/`.\n- **Credenciales**:\n  - Preferir `VaultCredential` (cifrado **Fernet** mediante `ENCRYPTION_KEY_VAULT`).\n  - Evitar `customPass` en texto plano (si se usa, considerar cifrarlo).\n\n---\n\n## ğŸ—‚ï¸ Estructura de proyecto (parcial)\n```\nnetback-backend/\nâ”œâ”€ backend/\nâ”‚  â”œâ”€ settings.py\nâ”‚  â”œâ”€ urls.py\nâ”‚  â”œâ”€ celery.py\nâ”œâ”€ core/\nâ”‚  â”œâ”€ models.py\nâ”‚  â”œâ”€ views.py\nâ”‚  â”œâ”€ serializers.py\nâ”‚  â”œâ”€ tasks.py\nâ”‚  â””â”€ network_util/\nâ”‚     â”œâ”€ backup.py\nâ”‚     â”œâ”€ comparison.py\nâ”‚     â”œâ”€ executor.py\nâ”‚     â””â”€ vlan_parser.py\nâ”œâ”€ utils/\nâ”‚  â”œâ”€ env.py\nâ”‚  â””â”€ zabbix_manager.py\nâ”œâ”€ entrypoint.sh\nâ”œâ”€ Dockerfile\nâ””â”€ requirements.txt\n```\n\n---\n\n## ğŸ“’ Notas relevantes\n- **Zona horaria** vÃ¡lida: `America/Santiago`.\n- Si usas **django_celery_beat** como scheduler, asegÃºrate de crear la `PeriodicTask` correspondiente.\n- El servicio `proxy` expone `/api/*` hacia este backend (no es necesario habilitar CORS si todo el trÃ¡fico viene por el proxy y Nginx del frontend).\n\n---\n\n## Licencia\nProyecto interno Netback. Uso restringido.