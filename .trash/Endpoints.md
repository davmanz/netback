# Netback — Endpoints (Backend Django REST)\n\nEste documento lista los **endpoints del backend** con su propósito, permisos y ejemplos.\n\n> **Base URL (directo al backend):** `http://netback-backend:8000/api`  \n> **Vía Proxy (recomendado desde el navegador):** `http://localhost:8080` con prefijo `/api` (Nginx del frontend apunta a `/api` → proxy → backend).\n\n---\n\n## 🔑 Autenticación (JWT)\nTodos los endpoints (salvo `health`) requieren **Bearer Token** en la cabecera:\n```\nAuthorization: Bearer &lt;ACCESS_TOKEN&gt;\n```\n\n### 1) Obtener token\n**POST** `/api/token/`\n\n**Body**\n```json\n{ \"username\": \"admin\", \"password\": \"adminpassword\" }\n```\n**cURL (directo backend)**\n```bash\ncurl -X POST http://localhost:8000/api/token/ \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"username\":\"admin\",\"password\":\"adminpassword\"}'\n```\n**Respuesta 200**\n```json\n{ \"access\": \"...\", \"refresh\": \"...\" }\n```\n\n### 2) Refrescar access token\n**POST** `/api/token/refresh/`\n```json\n{ \"refresh\": \"&lt;REFRESH_TOKEN&gt;\" }\n```\n\n### 3) Usuario autenticado (perfil)\n**GET** `/api/users/me/`  _(permiso: autenticado)_\n\n**cURL (vía proxy)**\n```bash\ncurl http://localhost:8080/api/users/me/ \\\n  -H \"Authorization: Bearer &lt;ACCESS&gt;\"\n```\n\n---\n\n## 👥 Usuarios\n**Base:** `/api/users/`  \nRecurso DRF **ModelViewSet**.\n\n- **GET** `/api/users/` — listar (🟢 *admin, operator, viewer*)\n- **GET** `/api/users/{uuid}/` — detalle (🟢 *admin, operator, viewer*)\n- **POST** `/api/users/` — crear (🔐 *admin*)\n- **PUT/PATCH** `/api/users/{uuid}/` — actualizar (🔐 *admin* o el propio usuario con restricciones)\n- **DELETE** `/api/users/{uuid}/` — eliminar (🔐 *admin*)\n\n**Crear usuario (ejemplo)**\n```bash\ncurl -X POST http://localhost:8000/api/users/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;' -H 'Content-Type: application/json' \\\n  -d '{\n    \"username\":\"oper1\",\n    \"email\":\"oper1@example.com\",\n    \"password\":\"password123\",\n    \"role\":\"operator\"\n  }'\n```\n\n---\n\n## 🌍 Ubicaciones\n### Países\n**Base:** `/api/countries/`  \n- **GET** listar/detalle (🟢 auth)\n- **POST/PUT/PATCH/DELETE** (🟢 auth, según lógica interna)\n\n### Sitios\n**Base:** `/api/sites/`  \nParámetro: `?country_id=&lt;uuid&gt;`\n\n### Áreas\n**Base:** `/api/areas/`  \nParámetros: `?site_id=&lt;uuid&gt;` **o** `?country_id=&lt;uuid&gt;`\n\n**Ejemplo listar áreas por sitio**\n```bash\ncurl 'http://localhost:8000/api/areas/?site_id=&lt;SITE_UUID&gt;' \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;'\n```\n\n---\n\n## 🏷️ Fabricantes / Tipos de Dispositivo\n### Fabricantes\n**Base:** `/api/manufacturers/`  \nCampos relevantes: `name`, `get_running_config`, `get_vlan_info`, `netmiko_type`.\n\n### Tipos\n**Base:** `/api/devicetypes/`\n\n---\n\n## 🔐 Vault Credentials\n**Base:** `/api/vaultcredentials/` (🔐 *operator+*)\n- Guarda credenciales cifradas (**Fernet**) para dispositivos.\n\n**Crear**\n```bash\ncurl -X POST http://localhost:8000/api/vaultcredentials/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;' -H 'Content-Type: application/json' \\\n  -d '{\"nick\":\"cisco-core\",\"username\":\"netops\",\"password\":\"s3cr3t\"}'\n```\n\n---\n\n## 🔌 Dispositivos de Red\n**Base:** `/api/networkdevice/` (DRF ModelViewSet)\n- **GET** listar/detalle — (🟢 *viewer+*)\n- **POST** crear — (🔐 *operator+*)\n- **PUT/PATCH/DELETE** — (🔐 *admin*)\n\n**Crear dispositivo**\n```bash\ncurl -X POST http://localhost:8000/api/networkdevice/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;' -H 'Content-Type: application/json' \\\n  -d '{\n    \"hostname\":\"switch-core\",\n    \"ipAddress\":\"192.168.1.10\",\n    \"model\":\"Cisco IOS\",\n    \"manufacturer\":\"&lt;UUID_MANUFACTURER&gt;\",\n    \"deviceType\":\"&lt;UUID_DEVICETYPE&gt;\",\n    \"area\":\"&lt;UUID_AREA&gt;\",\n    \"vaultCredential\":\"&lt;UUID_VAULT&gt;\"\n  }'\n```\n> **Nota:** No mezclar `vaultCredential` **y** `customUser/customPass`.\n\n### Acciones sobre un dispositivo\n1) **Ejecutar comando**  \n**POST** `/api/networkdevice/{uuid}/command/` (Body: `{ \"command\": \"show running-config\" }`)\n```bash\ncurl -X POST http://localhost:8000/api/networkdevice/&lt;DEV_UUID&gt;/command/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;' -H 'Content-Type: application/json' \\\n  -d '{\"command\":\"show version\"}'\n```\n\n2) **Backup manual**  \n**POST** `/api/networkdevice/{uuid}/backup/`\n```bash\ncurl -X POST http://localhost:8000/api/networkdevice/&lt;DEV_UUID&gt;/backup/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;'\n```\n**Respuesta 200**\n```json\n{ \"success\": true, \"backupId\": \"...\", \"parsed_vlan\": { ... } }\n```\n\n3) **Historial de backups**  \n**GET** `/api/networkdevice/{uuid}/backups/`\n\n4) **Comparar 2 últimos backups**  \n**GET** `/api/networkdevice/{uuid}/compare/`\n```json\n{\n  \"success\": true,\n  \"backupDiffId\": \"...\",\n  \"changes\": {\n    \"added\": [ ... ],\n    \"removed\": [ ... ],\n    \"modified\": [ ... ],\n    \"vlanInfo\": { \"vlans\": { ... }, \"ports_vlan\": { ... } }\n  }\n}\n```\n\n5) **Estados de backup del dispositivo**  \n**GET** `/api/networkdevice/{uuid}/status/`\n\n---\n\n## 💾 Backups\n**Base:** `/api/backup/` (DRF ModelViewSet, 🟢 viewer+ para listar/detalle)\n\n### Último backup por dispositivo\n**GET** `/api/backups/last/`\n```bash\ncurl http://localhost:8000/api/backups/last/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;'\n```\n\n### Comparar backups por ID\n**GET** `/api/backups/compare/{backupOldId}/{backupNewId}/`\n\n---\n\n## 🕒 Programación de Backups (Admin)\n1) **Actualizar hora programada**  \n**POST** `/api/backup-config/schedule/`\n```json\n{ \"scheduled_time\": \"01:00\" }\n```\n\n2) **Consultar hora programada**  \n**GET** `/api/backup-config/schedule/get/`\n\n> El **scheduler** ejecuta `core.tasks.autoBackup` y corre los backups cuando `HH:MM` actual coincide con `scheduled_time`.\n\n---\n\n## 🧭 Clasificación e Ingesta Masiva\n### Desde Zabbix (Admin)\n**POST** `/api/networkdevice/bulk/from-zabbix/`\n```json\n{ \"ruleSetId\": \"&lt;UUID_RULESET&gt;\" }\n```\n**Respuesta**: lista de hosts clasificados (incluye `manufacturer`, `deviceType`, `area.id` y campos faltantes en `missing`).\n\n### Desde CSV (Admin)\n**POST** `/api/networkdevice/bulk/from-csv/` (multipart)\n```bash\ncurl -X POST http://localhost:8000/api/networkdevice/bulk/from-csv/ \\\n  -H 'Authorization: Bearer &lt;ACCESS&gt;' \\\n  -F 'ruleSetId=&lt;UUID_RULESET&gt;' \\\n  -F 'file=@hosts.csv'\n```\n\n### Guardar clasificados\n**POST** `/api/networkdevice/bulk/save/`\n```json\n{\n  \"hosts\": [\n    {\n      \"hostname\": \"edge-01\",\n      \"ipAddress\": \"10.0.0.10\",\n      \"model\": \"Cisco IOS\",\n      \"manufacturer\": \"&lt;UUID_MANUFACTURER&gt;\",\n      \"deviceType\": \"&lt;UUID_DEVICETYPE&gt;\",\n      \"area\": \"&lt;UUID_AREA&gt;\",\n      \"vaultCredential\": \"&lt;UUID_VAULT&gt;\"\n    }\n  ]\n}\n```\n\n---\n\n## 📡 Utilidades\n### Health\n**GET** `/api/health/` (público)\n```bash\ncurl http://localhost:8000/api/health/\n```\n\n### Ping (diagnóstico desde servidor)\n**POST** `/api/ping/`\n```json\n{ \"ip\": \"8.8.8.8\" }\n```\n**Respuesta (éxito)**\n```json\n{\n  \"status\": \"success\",\n  \"data\": { \"ip\": \"8.8.8.8\", \"reachable\": true, \"message\": \"✅ Dispositivo activo\", \"stats\": {\"transmitted\":2,\"received\":2,\"loss_percentage\":0} }\n}\n```\n\n### Estado de conectividad Zabbix (Admin)\n**GET** `/api/zabbix/status/`\n**Respuesta**\n```json\n{\n  \"activate\": true,\n  \"zabbix_api_status\": \"ok\",\n  \"connect_attempted\": true,\n  \"ping\": { \"drop\": 0, \"pass\": 2 }\n}\n```\n\n---\n\n## 🔒 Permisos por rol (resumen)\n- **viewer**: lectura (listar/detalle de inventario y backups)\n- **operator**: todo lo de viewer + crear dispositivos y backups manuales\n- **admin**: CRUD completo + clasificación/ingesta masiva + programación de backups + gestión de usuarios/credenciales\n\n> La protección se aplica en los `ViewSet` via `IsViewer / IsOperator / IsAdmin`.\n\n---\n\n## 🧾 Códigos de respuesta comunes\n- `200 OK`, `201 Created`, `204 No Content`\n- `400 Bad Request` (validación), `401 Unauthorized` (sin/expirado token), `403 Forbidden` (rol insuficiente), `404 Not Found`\n\n---\n\n## 🧪 Secuencias típicas\n**Alta de equipo con backup manual y diff**\n1. Crear Manufacturer/DeviceType/Site/Area si faltan\n2. Crear `VaultCredential`\n3. Crear `NetworkDevice`\n4. `POST /networkdevice/{id}/backup/` (dos veces en momentos distintos)\n5. `GET /networkdevice/{id}/compare/` → cambios por secciones y VLAN\n\n---\n\n## Notas\n- No mezcles `vaultCredential` con `customUser/customPass` al crear/editar un dispositivo.\n- `ENCRYPTION_KEY_VAULT` debe estar configurada para cifrado de `VaultCredential`.\n- `TIME_ZONE` recomendado: `America/Santiago`.\n